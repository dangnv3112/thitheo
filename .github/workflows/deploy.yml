name: Deploy to GitHub Pages

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      NODE_ENV: production
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          
      - name: Update package.json
        run: |
          echo '{
            "name": "tho-gio",
            "version": "0.1.0",
            "private": true,
            "scripts": {
              "dev": "next dev",
              "build": "next build",
              "start": "next start",
              "lint": "next lint"
            },
            "dependencies": {
              "@react-google-maps/api": "^2.19.2",
              "date-fns": "^2.30.0",
              "next": "14.0.4",
              "react": "^18.2.0",
              "react-dom": "^18.2.0",
              "react-hot-toast": "^2.4.1",
              "react-icons": "^4.12.0",
              "xlsx": "^0.18.5"
            },
            "devDependencies": {
              "@tailwindcss/forms": "^0.5.7",
              "@tailwindcss/typography": "^0.5.10",
              "@types/node": "^20.10.5",
              "@types/react": "^18.2.45",
              "@types/react-dom": "^18.2.18",
              "autoprefixer": "^10.4.16",
              "eslint": "^8.56.0",
              "eslint-config-next": "14.0.4",
              "postcss": "^8.4.32",
              "tailwindcss": "^3.3.6",
              "typescript": "^5.3.3"
            }
          }' > package.json
          
      - name: Create postcss.config.js
        run: echo 'module.exports = { plugins: { tailwindcss: {}, autoprefixer: {} } }' > postcss.config.js
          
      - name: Create tailwind.config.js
        run: |
          echo '/** @type {import("tailwindcss").Config} */
          module.exports = {
            content: [
              "./pages/**/*.{js,ts,jsx,tsx,mdx}",
              "./components/**/*.{js,ts,jsx,tsx,mdx}",
              "./app/**/*.{js,ts,jsx,tsx,mdx}",
            ],
            theme: {
              extend: {
                colors: {
                  primary: "#ef4444",
                },
              },
            },
            plugins: [
              require("@tailwindcss/forms"),
              require("@tailwindcss/typography"),
            ],
          }' > tailwind.config.js
          
      - name: Create next.config.js
        run: |
          echo '/** @type {import("next").NextConfig} */
          const nextConfig = {
            output: "export",
            images: {
              unoptimized: true,
            },
            basePath: "/thitheo",
            assetPrefix: "/thitheo",
            trailingSlash: true,
            eslint: {
              ignoreDuringBuilds: true,
            },
            typescript: {
              ignoreBuildErrors: true,
            }
          }
          
          module.exports = nextConfig' > next.config.js
          
      - name: Install dependencies
        run: |
          rm -rf node_modules
          npm install
          npm list tailwindcss postcss autoprefixer
          
      - name: Run build
        run: npm run build
          
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./out

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4 